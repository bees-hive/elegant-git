#!/usr/bin/env bash
set -e

source ./libexec/plugins/text

WORKER_IMAGE="beeshive/elegant-git-ci:4"

testing() {
    docker run -it --rm -v $PWD:/eg ${WORKER_IMAGE} .workflows/bats-pipeline.bash "$@"
}

generate-docs() {
    python .workflows/docs.py
}

preview-docs() {
    sleep 5 && open http://localhost:8000 &
    python -m mkdocs serve
}

serve-docs() {
    generate-docs
    preview-docs
}

repository() {
    info-text "Start container..."
    docker run -idt --rm --name repository --workdir /tmp/elegant-git-repo -v $PWD:/eg ${WORKER_IMAGE} bash
    info-text "Init repository..."
    docker exec -it repository bash -c "source /eg/tests/addons-repo.bash;source /eg/tests/addons-common.bash; repo-new"
    info-text "Install Elegant Git..."
    docker exec -it repository bash -c "
        cd /eg
        git config --global user.name \"Elegant Git\"
        git config --global user.email elegant.git@email.com
        git config --global core.editor vi
        git config --global elegant-git.protected-branches master
        git config --global elegant-git.acquired true
        ./install.bash /usr/local src
    "
    info-text "Ready! Enjoy experiments..."
    docker attach repository
}

ci() {
    docker run --rm -v $PWD:/eg ${WORKER_IMAGE} .workflows/ci-pipeline.bash testing
}

prepare-worker() {
    if [[ -z ${1} ]]; then
        error-text "Please specify a tag for Docker image (like '2')"
    fi
    docker build --no-cache -t beeshive/elegant-git-ci:${1} .
}

publish-worker() {
    if [[ -z ${1} ]]; then
        error-text "Please specify a tag for Docker image (like '2')"
    fi
    docker push beeshive/elegant-git-ci:${1}
}

robot() {
    # runs a
    local smart_testing_status=""
    local command_files=($(git ls-files --modified --other -- libexec/git-elegant*))

    for command_file in ${command_files[@]}; do
        local command_name=$(basename ${command_file})
        if ! test -f tests/${command_name}.bats; then continue; fi
        ( testing ${command_name} && info-text "'${command_file}' testing is passed." ) || {
            error-text "'${command_name}' testing is failed."
            smart_testing_status=failed
        }
    done
    local tests_files=($(git ls-files --modified --other -- tests/git-elegant*.bats))
    for test_file in ${tests_files[@]}; do
        local file_name=$(basename ${test_file})
        if [[ ${command_files[@]} =~ "${file_name/.bats/}" ]] ; then
            continue # already tested
        fi
        if ! test -f tests/${command_name}.bats; then continue; fi
        ( testing ${file_name} && info-text "'${file_name}' testing is passed.") || {
            error-text "'${file_name}' testing is failed."
            smart_testing_status=failed
        }
    done
    if test -z "${smart_testing_status}"; then
        info-text "Everything is great!"
    else
        error-text "Something should be improved!"
        exit 1
    fi
}

usage() {
    cat <<MESSAGE
usage: ${BASH_SOURCE[0]} [command] [arg]...

Available commands:
    help            prints this message
    testing         runs bats tests; accepts a optional pattern for tests
                    filtering ("${BASH_SOURCE[0]} testing work" run all tests
                    which have the word in the test name)
    robot           runs tests for updated "libexec/git-elegant*" or
                    "tests/git-elegant*.bats" files
    repository      creates a git repository and installs Elegant Git within
    generate-docs   generates fresh commands documentation bases on the latest
                    changes
    preview-docs    shows current documentation
    serve-docs      generates and shows latest documentation
    ci              runs CI quality assessment workflow
    prepare-worker  builds a new worker image
    publish-worker  pushes a new worker image
MESSAGE
}

commands=(
    usage
    testing
    robot
    repository
    generate-docs
    preview-docs
    serve-docs
    ci
    prepare-worker
    publish-worker
)

main() {
    local command=${1}
    if [[ -z ${command} ]]; then
        question-text "Please select a command:"
        echo ""
        select any in ${commands[@]}; do
            command=${any}
            if test ${command} = testing; then
                question-text "Please give the tests pattern: "
                read args
            fi
            break
        done
    else
        shift
    fi
    info-box "Run:" ${command} ${args:-${@}}
    ${command} ${args:-${@}}
}

main ${@}
